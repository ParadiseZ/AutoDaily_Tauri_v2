# Infrastructure模块拆分指南

## 概述

本文档描述了将原有的`infrastructure`模块拆分为多个更小、更专注的子模块的过程。这次重构旨在提高代码的可维护性、可测试性和模块化程度。

## 拆分后的模块结构

拆分后，原来的`infrastructure`模块被拆分为以下6个子模块：

1. **infra-core** - 核心基础设施功能
2. **infra-process** - 进程管理相关功能
3. **infra-ipc** - 进程间通信功能
4. **infra-vision** - 视觉处理功能
5. **infra-device** - 设备管理功能
6. **infra-script** - 脚本执行功能

## 各模块职责

### infra-core
- 提供所有基础设施模块共享的核心功能
- 定义通用接口和类型
- 提供基础工具函数和错误处理
- 作为其他infra模块的依赖基础

### infra-process
- 进程创建和管理
- 进间间通信的基础设施
- 系统资源监控
- 进程生命周期管理

### infra-ipc
- 高级进程间通信机制
- 消息传递和事件系统
- 共享内存管理
- 管道和套接字抽象

### infra-vision
- 图像处理和分析
- 计算机视觉算法实现
- ORT (ONNX Runtime) 集成
- 视觉数据结构定义

### infra-device
- 设备发现和管理
- ADB (Android Debug Bridge) 集成
- 屏幕捕获功能
- 设备状态监控

### infra-script
- 脚本执行引擎
- 脚本语言解析和执行
- 脚本结果处理
- 脚本缓存和优化

## 依赖关系

```
┌─────────────────────────────────────────────────────────────┐
│                        ad_main                              │
└─────────────────────┬───────────────────────────────────────┘
                      │
┌─────────────────────▼───────────────────────────────────────┐
│                        ad_api                               │
└─────────────────────┬───────────────────────────────────────┘
                      │
┌─────────────────────▼───────────────────────────────────────┐
│                        ad_app                               │
└─────────────┬───────────────┬───────────────┬───────────────┘
              │               │               │
┌─────────────▼───────┐ ┌─────▼─────┐ ┌─────▼─────┐ ┌─────────▼─────────┐
│    ad_domain        │ │ ad_core   │ │ infra-*   │ │    ad_infra_*     │
│                     │ │           │ │ (多个)    │ │    (多个)         │
└─────────────────────┘ └───────────┘ └───────────┘ └───────────────────┘
```

所有infra-*模块都依赖于ad_infra_core，而其他模块可以根据需要依赖特定的infra子模块。

## 代码迁移步骤

1. **创建新模块结构**
   - 创建各个infra子模块的目录结构
   - 设置各模块的Cargo.toml文件

2. **迁移代码**
   - 将相关代码从原infrastructure模块移动到对应的子模块
   - 更新模块内的导入路径

3. **更新依赖**
   - 更新所有模块的Cargo.toml文件，使用新的模块路径
   - 更新代码中的导入语句

4. **测试验证**
   - 确保所有测试通过
   - 验证功能完整性

## 优势

1. **更好的关注点分离** - 每个模块专注于特定功能领域
2. **提高可维护性** - 更小的模块更容易理解和修改
3. **增强可测试性** - 可以独立测试每个模块
4. **减少编译时间** - 修改一个模块不需要重新编译整个基础设施
5. **更清晰的依赖关系** - 明确的模块依赖图
6. **更好的并行开发** - 不同团队可以并行开发不同的模块

## 注意事项

1. **公共接口** - 确保infra-core提供的公共接口足够稳定
2. **循环依赖** - 避免在infra子模块之间创建循环依赖
3. **版本兼容性** - 确保所有infra子模块使用兼容的依赖版本
4. **文档更新** - 及时更新相关文档和示例代码

## 故障排除

### 编译错误
- 检查所有模块的Cargo.toml文件中的依赖路径是否正确
- 确保所有必要的依赖都已正确添加

### 运行时错误
- 检查模块初始化顺序是否正确
- 确保所有必要的资源都已正确加载

### 性能问题
- 分析模块间的通信开销
- 考虑将频繁交互的功能合并到同一模块中

## 后续优化建议

1. **进一步细化** - 根据需要进一步拆分大型模块
2. **接口标准化** - 为所有infra模块定义标准接口
3. **性能优化** - 分析和优化模块间的通信开销
4. **文档完善** - 为每个模块提供详细的API文档
5. **示例代码** - 为每个模块提供使用示例

## 总结

通过将infrastructure模块拆分为多个专门的子模块，我们实现了更好的代码组织和模块化。这种结构使得代码更容易理解、维护和扩展，同时减少了模块间的耦合度，提高了整个系统的灵活性和可维护性。